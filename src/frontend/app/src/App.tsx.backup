import { useEffect, useState } from 'react'
import { getTemperatures, type Temperature, usersExist, authHeader } from './api'
import { useNavigate } from 'react-router-dom'
import MainLayout from './components/MainLayout'
import SensorsContent from './components/SensorsContent'

export default function App() {
  const [data, setData] = useState<Temperature[]>([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)
  const navigate = useNavigate()

  useEffect(() => {
    // Check authentication and users
    usersExist().then((exists) => {
      const hasToken = !!authHeader().Authorization
      if (!exists && !hasToken) {
        navigate('/register', { replace: true })
        return
      }
      if (!hasToken) {
        navigate('/login', { replace: true })
        return
      }
    })

    // Load temperature data
    getTemperatures()
      .then(setData)
      .catch(setError)
      .finally(() => setLoading(false))
  }, [navigate])

  // Convert Temperature data to match Dashboard's expected format
  const temperatures = data.map(temp => ({
    id: temp.id,
    value: temp.celsius,
    timestamp: temp.timestamp,
    sensor: temp.sensor || 'Default Sensor'
  }))

  if (loading) {
    return (
      <MainLayout>
        <SensorsContent temperatures={[]} />
      </MainLayout>
    )
  }

  if (error) {
    return (
      <MainLayout>
        <SensorsContent temperatures={[]} />
      </MainLayout>
    )
  }

  return (
    <MainLayout>
      <SensorsContent temperatures={temperatures} />
    </MainLayout>
  )
}
